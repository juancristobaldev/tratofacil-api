// =========================================================
// CONFIGURACIÓN GLOBAL
// =========================================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =========================================================
// ENUMS
// =========================================================
enum Role {
  CLIENT
  PROVIDER
  ADMIN
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  FAILED
  SUCCESS
}

enum PaymentProvider {
  WEBPAY
  MERCADOPAGO
  TRANSFER
}

enum PaymentStatus {
  INITIATED
  CONFIRMED
  FAILED
}

// =========================================================
// 1. USUARIOS
// =========================================================
model User {
  id            Int      @id @default(autoincrement())
  username      String   @unique
  email         String   @unique
  password      String
  displayName   String
  nicename      String
  url           String   @default("")
  status        Int      @default(0)
  registered    DateTime @default(now())
  activationKey String   @default("")
  role          Role?    @default(CLIENT)

  provider      Provider?
  orders        Order[]        @relation("ClientOrders")
  productOrders OrderProduct[] @relation("ClientProductOrders")
  reviews       ProviderReview[] @relation("ClientReviews")
}

// =========================================================
// 2. CATEGORÍAS Y SERVICIOS
// =========================================================
model Category {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  description String?
  parentId    Int?
  imageUrl    String?

  services Service[] @relation("CategoryServices")

  @@index([parentId])
}

model Service {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  description String?
  imageUrl    String?
  categoryId  Int?
  category    Category? @relation("CategoryServices", fields: [categoryId], references: [id], onDelete: Cascade)

  serviceProviders ServiceProvider[]
}

// =========================================================
// 3. PROVEEDORES
// =========================================================
model Provider {
  id           Int  @id @default(autoincrement())
  userId       Int  @unique
  wcCategoryId Int?

  name     String
  slug     String  @unique
  location String?
  logoUrl  String?

  rut      String?
  bio      String?
  phone    String?

  bank         BankAccount?
  reviews      ProviderReview[]
  certificates ProviderCertificate[]
  services     ServiceProvider[]
  products     Product[]
  productOrders OrderProduct[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  hobbys Hobby[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Hobby {
  id         Int      @id @default(autoincrement())
  name       String
  providerId Int
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// =========================================================
// 4. SERVICE PROVIDER (Oferta Específica)
// =========================================================
model ServiceProvider {
  id         Int @id @default(autoincrement())
  serviceId  Int
  providerId Int

  slug         String  @unique
  description  String?
  price        Float?
  commission   Float?
  netAmount    Float?
  hasHomeVisit Boolean @default(false)

  orders Order[]

  service  Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Relación con la tabla pivot de ciudades
  cities ServiceProviderOnCity[]

  @@unique([serviceId, providerId])
  @@index([providerId])
  @@index([serviceId])
}

// =========================================================
// 5. CIUDADES (Tabla Pivot para relación N:M manual)
// =========================================================
model ServiceProviderOnCity {
  serviceProviderId Int
  city              String // El nombre de la ciudad servirá como parte de la PK

  serviceProvider ServiceProvider @relation(fields: [serviceProviderId], references: [id], onDelete: Cascade)

  @@id([serviceProviderId, city])
  @@index([city])
}

// =========================================================
// 6. MARKETPLACE (PRODUCTOS)
// =========================================================
model CategoryProduct {
  id          Int       @id @default(autoincrement())
  name        String
  slug        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]
}

model Product {
  id                Int               @id @default(autoincrement())
  name              String
  slug              String            @unique
  description       String?
  specifications    Json?             // Especificaciones del producto (MySQL Json)
  price             Float             // Precio base del proveedor
  stock             Int               @default(0)
  
  // ✅ RELACIONES ACTUALIZADAS
  images            ProductImage[]
  deliveryCondition ConditionDelivery? // Condiciones de entrega asociadas al producto

  providerId        Int
  provider          Provider          @relation(fields: [providerId], references: [id], onDelete: Cascade)
  
  categoryProductId Int
  categoryProduct   CategoryProduct   @relation(fields: [categoryProductId], references: [id], onDelete: Cascade)

  orders            OrderProduct[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model ProductImage {
  id        Int      @id @default(autoincrement())
  url       String   // URL o Key de la imagen
  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([productId])
}

// =========================================================
// 7. REVIEWS Y CERTIFICADOS
// =========================================================
model ProviderReview {
  id        Int      @id @default(autoincrement())
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  clientId Int
  client    User @relation("ClientReviews", fields: [clientId], references: [id], onDelete: Cascade)

  providerId Int
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  orderId Int?   @unique
  order   Order? @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model ProviderCertificate {
  id          Int      @id @default(autoincrement())
  providerId  Int
  title       String
  institution String?
  year        Int?
  fileUrl     String
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
}

// =========================================================
// 8. BANK ACCOUNT
// =========================================================
model BankAccount {
  id            Int     @id @default(autoincrement())
  bankName      String
  accountNumber String
  accountType   String
  rut           String?
  email         String?

  providerId Int      @unique
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =========================================================
// 9. ÓRDENES Y PAGOS
// =========================================================
model Order {
  id Int @id @default(autoincrement())

  clientId Int
  client   User @relation("ClientOrders", fields: [clientId], references: [id], onDelete: Cascade)

  total      Float
  status     OrderStatus @default(PENDING)
  wcOrderId  Int?
  wcOrderKey String?

  serviceProviderId Int?
  serviceProvider   ServiceProvider? @relation(fields: [serviceProviderId], references: [id], onDelete: Cascade)

  payment Payment?
  review  ProviderReview?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderProduct {
  id          Int          @id @default(autoincrement())
  clientId    Int
  client      User         @relation("ClientProductOrders", fields: [clientId], references: [id], onDelete: Cascade)
  providerId  Int
  provider    Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  productId   Int
  product     Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity    Int          @default(1)
  unitPrice   Float
  commission  Float
  total       Float
  status      OrderStatus  @default(PENDING)



  payment     PaymentProduct?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model ConditionDelivery {
  id                    Int      @id @default(autoincrement())
  productId             Int      @unique
  product               Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  deliveryType          String   // Ej: "Despacho a domicilio", "Retiro en tienda"
  shippingPayer         String   // Ej: "Vendedor", "Comprador"
  maxDispatchDays       Int      // Plazo máximo de despacho (días)
  confirmationDeadline  DateTime // Fecha límite de confirmación (ej: antes de las 18:00)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([productId])
}

model Payment {
  id Int @id @default(autoincrement())

  orderId Int   @unique
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  amount        Float
  provider      PaymentProvider
  status        PaymentStatus   @default(INITIATED)
  transactionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PaymentProduct {
  id Int @id @default(autoincrement())

  orderProductId Int          @unique
  orderProduct   OrderProduct @relation(fields: [orderProductId], references: [id], onDelete: Cascade)

  amount        Float
  provider      PaymentProvider
  status        PaymentStatus   @default(INITIATED)
  transactionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =========================================================
// 10. VERIFICACIÓN DE EMAIL
// =========================================================
model EmailVerification {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}