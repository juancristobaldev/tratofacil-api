// =========================================================
// CONFIGURACIÓN GLOBAL
// =========================================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =========================================================
// ENUMS
// =========================================================
enum Role {
  CLIENT
  PROVIDER
  ADMIN
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  FAILED
  SUCCESS
}

enum PaymentProvider {
  WEBPAY
  MERCADOPAGO
  TRANSFER
}

enum PaymentStatus {
  INITIATED
  CONFIRMED
  FAILED
}

// =========================================================
// 1. USUARIOS
// =========================================================
model User {
  id          Int      @id @default(autoincrement())
  username    String   @unique
  email       String   @unique
  displayName String
  nicename    String
  url         String   @default("")
  status      Int      @default(0)
  registered  DateTime @default(now())
  activationKey String @default("")
  role        Role?    @default(CLIENT)

  provider   Provider?
  usermeta   UserMeta[]
  orders     Order[]   @relation("ClientOrders")
  reviews    ProviderReview[] @relation("ClientReviews")
}

// Datos extra tipo key/value
model UserMeta {
  id     Int    @id @default(autoincrement())
  userId Int
  key    String
  value  String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// =========================================================
// 2. CATEGORÍAS Y SERVICIOS
// =========================================================
model Category {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  description String?
  parentId    Int?

  services Service[]

  @@index([parentId])
}

model Service {
  id            Int      @id @default(autoincrement())
  name          String
  slug          String   @unique
  description   String?
  price         Float?
  commission    Float?
  categoryId    Int?
  subCategoryId Int?
  netAmount     Float?
  hasHomeVisit  Boolean  @default(false)

  category    Category? @relation("CategoryServices", fields: [categoryId], references: [id])
  subCategory Category? @relation("SubCategoryServices", fields: [subCategoryId], references: [id])

  orders Order[]
  serviceProviders ServiceProvider[]
}

// =========================================================
// 3. PROVEEDORES
// =========================================================
model Provider {
  id          Int @id @default(autoincrement())
  userId      Int @unique
  wcCategoryId Int?

  name     String
  slug     String @unique
  location String?
  logoUrl  String?
  bio      String?
  phone    String?

  bank        BankAccount?
  reviews     ProviderReview[]
  certificates ProviderCertificate[]
  services     ServiceProvider[]
  user        User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =========================================================
// 4. SERVICE PROVIDER (Muchos a muchos)
// =========================================================
model ServiceProvider {
  id         Int @id @default(autoincrement())
  serviceId  Int
  providerId Int

  service  Service  @relation(fields: [serviceId], references: [id])
  provider Provider @relation(fields: [providerId], references: [id])

  @@unique([serviceId, providerId])
  @@index([providerId])
  @@index([serviceId])
}

// =========================================================
// 5. REVIEWS Y CERTIFICADOS
// =========================================================
model ProviderReview {
  id         Int  @id @default(autoincrement())
  providerId Int
  clientId   Int
  orderId    Int? @unique
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())

  provider Provider @relation(fields: [providerId], references: [id])
  client   User     @relation("ClientReviews", fields: [clientId], references: [id])
  order    Order?   @relation(fields: [orderId], references: [id])
}

model ProviderCertificate {
  id          Int  @id @default(autoincrement())
  providerId  Int
  title       String
  institution String?
  year        Int?
  fileUrl     String
  verified    Boolean @default(false)
  createdAt   DateTime @default(now())

  provider Provider @relation(fields: [providerId], references: [id])
}

// =========================================================
// 6. BANK ACCOUNT
// =========================================================
model BankAccount {
  id            Int   @id @default(autoincrement())
  bankName      String
  accountNumber String
  accountType   String
  rut           String?
  email         String?

  providerId Int   @unique
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =========================================================
// 7. ÓRDENES Y PAGOS
// =========================================================
model Order {
  id        Int @id @default(autoincrement())
  clientId  Int
  client    User   @relation("ClientOrders", fields: [clientId], references: [id])

  total     Float
  status    OrderStatus @default(PENDING)

  wcOrderId  Int?
  wcOrderKey String?

  productId Int?
  product   Service? @relation(fields: [productId], references: [id])

  payment  Payment?
  review   ProviderReview?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id      Int @id @default(autoincrement())
  orderId Int @unique
  order   Order  @relation(fields: [orderId], references: [id])

  amount        Float
  provider      PaymentProvider
  status        PaymentStatus @default(INITIATED)
  transactionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =========================================================
// 8. VERIFICACIÓN DE EMAIL
// =========================================================
model EmailVerification {
  id        Int  @id @default(autoincrement())
  email     String  @unique
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}
