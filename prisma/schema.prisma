// =========================================================
// CONFIGURACIÓN GLOBAL
// =========================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =========================================================
// ENUMS (Lógica interna de la App)
// =========================================================

enum Role {
  CLIENT
  PROVIDER
  ADMIN
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  FAILED
}

enum PaymentProvider {
  WEBPAY
  MERCADOPAGO
  TRANSFER
}

enum PaymentStatus {
  INITIATED
  CONFIRMED
  FAILED
}

// =========================================================
// 1. CORE DE WORDPRESS (USUARIOS Y ROLES)
// =========================================================

/// Mapeo exacto de la tabla de usuarios de WordPress
model User {
  id       Int    @id @default(autoincrement()) @map("ID")
  username String @unique @map("user_login") @db.VarChar(60)
  password String @map("user_pass") @db.VarChar(255)
  nicename String @map("user_nicename") @db.VarChar(50)
  email    String @unique @map("user_email") @db.VarChar(100)
  url      String @default("") @map("user_url") @db.VarChar(100)

  // CAMBIO AQUÍ: de 'createdAt' a 'registered'
  registered DateTime @default(now()) @map("user_registered")

  activationKey String @default("") @map("user_activation_key") @db.VarChar(255)
  status        Int    @default(0) @map("user_status")
  displayName   String @default("") @map("display_name") @db.VarChar(250)

  // Relaciones
  usermeta UserMeta[]
  provider Provider?  @relation("UserProvider")
  orders   Order[]    @relation("ClientOrders")

  @@map("wp_users")
}

/// Mapeo de metadatos (Roles, Capabilities, etc.)
model UserMeta {
  umeta_id Int     @id @default(autoincrement())
  userId   Int     @map("user_id")
  key      String  @map("meta_key") @db.VarChar(255)
  value    String? @map("meta_value") @db.LongText

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "user_id")
  @@index([key], map: "meta_key")
  @@map("wp_usermeta")
}

// =========================================================
// 2. EXTENSIÓN DE LA APP (PROVEEDORES)
// =========================================================

/// Tabla propia para datos de negocio del proveedor
model Provider {
  id Int @id @default(autoincrement())

  // Relación con Usuario WP
  userId Int  @unique
  user   User @relation("UserProvider", fields: [userId], references: [id])

  // Relación lógica con Categoría WP (opcional, para agrupar servicios)
  wcCategoryId Int? @unique

  name     String
  slug     String  @unique
  location String?
  logoUrl  String?
  bio      String? @db.Text
  phone    String?

  bank      BankAccount?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model BankAccount {
  id            Int     @id @default(autoincrement())
  bankName      String
  accountNumber String
  accountType   String
  rut           String?
  email         String?

  providerId Int      @unique
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =========================================================
// 3. CATÁLOGO WORDPRESS (LECTURA)
// =========================================================

/// Términos base (Nombres y Slugs de categorías)
model WpTerm {
  term_id    BigInt @id @default(autoincrement())
  name       String @db.VarChar(200)
  slug       String @default("") @db.VarChar(200)
  term_group BigInt @default(0)

  taxonomies WpTermTaxonomy[]

  @@index([slug], map: "slug")
  @@index([name], map: "name")
  @@map("wp_terms")
}

/// Taxonomías (Jerarquía, Descripción y Conteo)
model WpTermTaxonomy {
  term_taxonomy_id BigInt @id @default(autoincrement())
  term_id          BigInt
  taxonomy         String @db.VarChar(32) // 'product_cat', 'product_tag'
  description      String @db.LongText
  parent           BigInt @default(0) // Padre de la categoría
  count            BigInt @default(0)

  term          WpTerm               @relation(fields: [term_id], references: [term_id])
  relationships WpTermRelationship[]

  @@unique([term_id, taxonomy], map: "term_id_taxonomy")
  @@index([taxonomy], map: "taxonomy")
  @@map("wp_term_taxonomy")
}

/// Relación M:N entre Productos (Posts) y Categorías (Taxonomías)
model WpTermRelationship {
  object_id        BigInt // ID del Post/Producto
  term_taxonomy_id BigInt
  term_order       Int    @default(0)

  taxonomy WpTermTaxonomy @relation(fields: [term_taxonomy_id], references: [term_taxonomy_id])
  post     WpPost         @relation(fields: [object_id], references: [ID])

  @@id([object_id, term_taxonomy_id])
  @@index([term_taxonomy_id], map: "term_taxonomy_id")
  @@map("wp_term_relationships")
}

/// Productos y Servicios (wp_posts)
model WpPost {
  ID           BigInt   @id @default(autoincrement())
  post_author  BigInt   @default(0)
  post_date    DateTime @default(now())
  post_content String   @db.LongText
  post_title   String   @db.Text
  post_status  String   @default("publish") @db.VarChar(20)
  post_type    String   @default("product") @db.VarChar(20)
  post_name    String   @default("") @db.VarChar(200) // Slug

  // Relaciones
  termRelationships WpTermRelationship[]
  postmeta          WpPostMeta[]

  @@index([post_name], map: "post_name")
  @@index([post_type, post_status, post_date, ID], map: "type_status_date")
  @@map("wp_posts")
}

/// Metadatos de productos (Precio, Proveedor, Home Visit)
model WpPostMeta {
  meta_id    BigInt  @id @default(autoincrement())
  post_id    BigInt
  meta_key   String? @db.VarChar(255)
  meta_value String? @db.LongText

  post WpPost @relation(fields: [post_id], references: [ID], onDelete: Cascade)

  @@index([post_id], map: "post_id")
  @@index([meta_key], map: "meta_key")
  @@map("wp_postmeta")
}

// =========================================================
// 4. VENTAS Y CONTROL (APP SPECIFIC)
// =========================================================

/// Tabla espejo de Órdenes para consulta rápida
model Order {
  id       Int  @id @default(autoincrement())
  clientId Int
  client   User @relation("ClientOrders", fields: [clientId], references: [id])

  // Datos financieros locales
  total  Float
  status OrderStatus @default(PENDING)

  // Vinculación con WooCommerce
  wcOrderId  Int?    @unique // ID real en WP
  wcOrderKey String? // Clave de seguridad de la orden

  payment   Payment?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id      Int   @id @default(autoincrement())
  orderId Int   @unique
  order   Order @relation(fields: [orderId], references: [id])

  amount        Float
  provider      PaymentProvider
  status        PaymentStatus   @default(INITIATED)
  transactionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailVerification {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}
